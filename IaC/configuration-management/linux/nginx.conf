# /etc/nginx/sites-available/default

upstream app {
        server 127.0.0.1:3000;
        keepalive 64;
}

# Notas.
# La instruccion para crear ssl_certificate y ssl_certificate_key es:
# sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt
# Luego la instruccion para crear ssl_dhparam es:
# sudo openssl dhparam -out /etc/nginx/dhparam.pem 4096
server {
        server_name _;

        location / {
                # Proxy_pass configuration
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header Host $http_host;
                proxy_set_header X-NginX-Proxy true; # Extra

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                auth_basic "Restricted Content"; # Mejor no usarlo por ahora.
                auth_basic_user_file /etc/nginx/.htpasswd; # sudo htpasswd -c /etc/nginx/.htpasswd usuario
                proxy_pass http://app/;
                proxy_redirect off;
                proxy_read_timeout 240s;

                proxy_max_temp_file_size 0; # Extra
        }

        listen 443 ssl;
        ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
        ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
        # options-ssl & ssl_dhparam
        # from https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-22-04
        # from https://cipherli.st/
        # and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html

        ssl_protocols TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_dhparam /etc/nginx/dhparam.pem;
        ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
        ssl_ecdh_curve secp384r1;
        ssl_session_timeout  10m;
        ssl_session_cache shared:SSL:10m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;
        # Disable strict transport security for now. You can uncomment the following
        # line if you understand the implications.
        #add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
}

server {
        server_name _;
        listen 80 default_server;
        listen [::]:80 default_server;
        return 301 https://$host$request_uri;
}

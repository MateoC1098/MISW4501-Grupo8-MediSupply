# https://docs.gitlab.com/ee/ci/yaml/yaml_optimization.html#reference-tags

# Steps to send the puppet folder and the auxiliar scripts to the desired machine.
# PORT: Integer - Example: 51086
# HOST: String - Example: $ALTAMIRA_CLOUD_ARENERO_HOST
# KEY_TO_USE: String - Example: 'key_devops_altamira_cloud_ecdsa'
# DESIRED_PUPPET_MANIFEST: String - Example: 'altamira-cloud.pp'
.template-puppet-setup:
  script:
    - eval $(ssh-agent -s)
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | bash
    - chmod 600 .secure_files/*
    - ssh-add -v ".secure_files/${KEY_TO_USE}"
    - mv "puppet/manifests/${DESIRED_PUPPET_MANIFEST}" puppet/manifests/site.pp
    - find puppet/manifests/ -type f ! -name "site.pp" -delete
    - find puppet/ -maxdepth 1 -type f -name "*.yml" -delete
    - tar -czvf puppet.tar.gz puppet
    - scp -P "${PORT}" puppet/main_work-machine.sh ubuntu@$HOST:~/; else scp -P "${PORT}" puppet/main_work-machine.sh ubuntu@$HOST:~/
    - scp -P "${PORT}" puppet.tar.gz ubuntu@$HOST:~/puppet.tar.gz; else scp -P "${PORT}" puppet.tar.gz ubuntu@$HOST:~/puppet.tar.gz
    - ssh -p "${PORT}" ubuntu@$HOST "tar -xzvf puppet.tar.gz"; else ssh -p "${PORT}" ubuntu@$HOST "tar -xzvf puppet.tar.gz"
    - scp -P "${PORT}" puppet/restringir-permisos.sh ubuntu@$HOST:~/puppet/restringir-permisos.sh; else scp -P "${PORT}" puppet/restringir-permisos.sh ubuntu@$HOST:~/puppet/restringir-permisos.sh
    - ssh -p "${PORT}" ubuntu@$HOST "chmod 700 main_work-machine.sh"; else ssh -p "${PORT}" ubuntu@$HOST "chmod 700 main_work-machine.sh"
    - ssh -p "${PORT}" ubuntu@$HOST "chmod 700 puppet/restringir-permisos.sh && cd puppet && ./restringir-permisos.sh"; else ssh -p "${PORT}" ubuntu@$HOST "chmod 700 puppet/restringir-permisos.sh && cd puppet && ./restringir-permisos.sh"
